import{fieldValidation,initializeInlineFieldValidation,handleScrollAndFocusOnError,handleCaptchaValidation}from"./validation";async function submitFormData(e){var t,r,s=new FormData(e),a=new FormData,o=["srfm-email-confirm","srfm-password-confirm"];for([t,r]of s.entries())o.includes(t)||(""!==r&&(e.querySelector(`[name="${t}"]`)?.closest(".srfm-block-single"))?.classList.contains("hide-element")&&(r=""),a.append(t,r));try{return await wp.apiFetch({path:"sureforms/v1/submit-form",method:"POST",body:a})}catch(e){console.log(e)}}async function afterSubmit(e){e=e.data.submission_id;try{await wp.apiFetch({path:"/sureforms/v1/after-submission/"+e,method:"GET"})}catch(e){console.error(e)}}function showSuccessMessage(e,t,r,s,a,o,i){o=new CustomEvent("srfm_on_show_success_message",{cancelable:!0,detail:{form:s,element:t,message:r,submitType:o,container:e,loader:i}});document.dispatchEvent(o)&&("hide form"===a?(s.style.opacity=1,s.style.display="none",setTimeout(()=>{t.style.opacity=1},500)):"reset form"===a&&s.reset(),t.innerHTML=r,e.classList.add("srfm-active"),window?.srfm?.handleInstantFormWrapperHeight(),s.parentElement.scrollIntoView({behavior:"smooth"}))}function redirectToUrl(e){window.location.assign(e)}function showErrorMessage(e){e.removeAttribute("hidden"),console.error("Network Error")}async function handleFormSubmission(t,r,s,e,a,o,i,c,n,m,l,u,d,f,b){try{a.classList.add("srfm-active");var h,p,v=await fieldValidation(r,s,e,t),y=handleCaptchaValidation(u,d,f,b);v?.validateResult||!y?(a.classList.remove("srfm-active"),v?.validateResult?handleScrollAndFocusOnError(v):y||handleScrollAndFocusOnError({firstErrorInput:b,scrollElement:b})):(h=new CustomEvent("srfm_on_trigger_form_submission",{cancelable:!0,detail:{form:t,loader:a,formId:r,submitType:m,successElement:c,successContainer:i}}),document.dispatchEvent(h)?(p=await submitFormData(t))?.success?(emitFormSubmitSuccess({...p,formId:r}),"same page"===m?(showSuccessMessage(i,c,p?.message??"",t,l,m),a.classList.remove("srfm-active")):["different page","custom url"].includes(m)?(p?.redirect_url&&redirectToUrl(p?.redirect_url),a.classList.remove("srfm-active")):showSuccessMessage(i,c,p?.message??"",t,l,m,a),p?.data?.after_submit&&afterSubmit(p)):(a.classList.remove("srfm-active"),showErrorMessage(n),a.classList.remove("srfm-active")):a.classList.remove("srfm-active"))}catch(e){s=new CustomEvent("srfm_on_trigger_form_submission_failure",{detail:{form:t,error:e,loader:a,formId:r,submitType:m,successElement:c,successContainer:i}});document.dispatchEvent(s),a.classList.remove("srfm-active"),showErrorMessage(n)}}function extractFormAttributesAndElements(e){var t=e.getAttribute("form-id"),r=e.getAttribute("message-type"),s=e.getAttribute("success-url"),a=e.getAttribute("ajaxurl"),o=e.getAttribute("nonce"),i=e.querySelector(".srfm-loader"),c=e.parentElement.querySelector(".srfm-single-form.srfm-success-box"),n=c?.querySelector(".srfm-success-box-description"),m=e.querySelector(".srfm-error-message"),l=e.querySelector("#srfm-submit-btn"),u=e.getAttribute("after-submission"),d=e.querySelector(".g-recaptcha");return{formId:t,submitType:r,successUrl:s,ajaxUrl:a,nonce:o,loader:i,successContainer:c,successElement:n,errorElement:m,submitBtn:l,siteKey:d?.getAttribute("data-sitekey"),recaptchaType:d?.getAttribute("recaptcha-type"),afterSubmission:u,captchaErrorElement:e.querySelector("#captcha-error"),hCaptchaDiv:e.querySelector(".h-captcha"),turnstileDiv:e.querySelector(".cf-turnstile")}}function recaptchaCallback(h=""){Array.from(document.querySelectorAll(".srfm-form")).forEach(e=>{const{formId:t,submitType:r,successUrl:s,ajaxUrl:a,nonce:o,loader:i,successContainer:c,successElement:n,errorElement:m,submitBtn:l,siteKey:u,recaptchaType:d,afterSubmission:f}=extractFormAttributesAndElements(e);let b=!1;"v2-invisible"===d&&(grecaptcha.render(l,{sitekey:u,callback:()=>{handleFormSubmission(e,t,a,o,i,s,c,n,m,r,f),b=!0}}),l.addEventListener("click",()=>{i.classList.add("srfm-active"),b&&handleFormSubmission(e,t,a,o,i,s,c,n,m,r,f)})),"v3-reCAPTCHA"===d&&h&&(i.classList.add("srfm-active"),handleFormSubmission(e,t,a,o,i,s,c,n,m,r,f))})}function emitFormSubmitSuccess(e){e=new CustomEvent("srfm_form_submission_success",{detail:{formId:"srfm-form-"+e.formId}});document.dispatchEvent(e)}document.addEventListener("DOMContentLoaded",function(){initializeInlineFieldValidation();for(const t of Array.from(document.querySelectorAll(".srfm-form"))){const{formId:r,submitType:s,successUrl:a,ajaxUrl:o,nonce:i,loader:c,successContainer:n,successElement:m,errorElement:l,recaptchaType:u,afterSubmission:d,captchaErrorElement:f,hCaptchaDiv:b,turnstileDiv:h}=extractFormAttributesAndElements(t),p="v2-checkbox"===u||!!b||!!h;t.addEventListener("submit",async e=>{e.preventDefault(),handleFormSubmission(t,r,o,i,c,a,n,m,l,s,d,p?u:void 0,p?b:void 0,p?h:void 0,p?f:void 0)})}}),window.recaptchaCallback=recaptchaCallback,window.handleBricksPreviewFormSubmission=function(){for(const e of Array.from(document.querySelectorAll(".srfm-form")))e.addEventListener("submit",async function(e){e.preventDefault()})};